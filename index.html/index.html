<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acceso - Capacita SM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: Arial, sans-serif;
    background: url('fondo.png') no-repeat center center fixed;
    background-size: cover;
}

@media (max-width: 768px) {
    body {
        background-attachment: scroll;
    }
}

#menuPrincipal, .seccion {
    background-color: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 10px;
    margin: 20px auto;
    max-width: 300px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    text-align: center;
}

#menuPrincipal button, .boton-volver {
    width: 100%;
    margin: 10px 0;
    padding: 12px;
    font-size: 16px;
    background-color: #4C7C46;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

#menuPrincipal button:hover, .boton-volver:hover {
    background-color: #3B6138;
}

.curso-tile {
    background: #A3C95A;
    padding: 10px;
    margin: 10px;
    display: inline-block;
    width: 150px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
}

.seccion, #panelEmpresa {
    display: none;
}

#panelEmpresa {
    display: flex;
    height: 100vh;
}

#menuLateral {
    width: 250px;
    background-color: rgba(255,255,255,0.95);
    padding: 20px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}

#menuLateral h3 {
    color: #4C7C46;
    margin-bottom: 10px;
}

#menuLateral p {
    margin: 5px 0;
    font-weight: bold;
}

#menuLateral button {
    margin-top: 15px;
    padding: 10px;
    background-color: #4C7C46;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
}

#menuLateral button:hover {
    background-color: #3B6138;
}

#contenidoEmpresa {
    flex-grow: 1;
    padding: 30px;
    background-color: rgba(255,255,255,0.9);
    margin: 20px;
    border-radius: 10px;
    overflow-y: auto;
}
</style>
</head>

<body>

<section id="menuPrincipal">
    <h2>Acceso</h2>
    <button onclick="mostrarTrabajador()">Trabajadores</button>
    <button onclick="mostrarEmpresa()">Empresas</button>
</section>

<section id="seccionTrabajador" class="seccion">
    <h2>Ingrese su RUT</h2>
    <input type="text" id="rutAcceso" placeholder="RUT">
    <button onclick="accederTrabajador()">Entrar</button>
    <button class="boton-volver" onclick="volverMenu()">Volver</button>
</section>

<section id="mosaicoCursos" class="seccion">
    <h2>Cursos Disponibles</h2>
    <div class="curso-tile" onclick="verCurso()">Uso y Manejo de Extintores</div>
    <button class="boton-volver" onclick="volverTrabajador()">Volver</button>
</section>

<section id="moduloCurso" class="seccion">
    <h2>Módulo 1: Uso y Manejo de Extintores</h2>
    <p>Los extintores deben estar visibles. <input type="text" id="p1"></p>
    <p>Los extintores no requieren mantención. <input type="text" id="p2"></p>
    <p>Se debe apuntar a la base del fuego. <input type="text" id="p3"></p>
    <button onclick="finalizarModulo()">Finalizar Módulo</button>
    <button class="boton-volver" onclick="volverCursos()">Volver</button>
</section>

<section id="evaluacionFinal" class="seccion">
    <h2>Evaluación Final</h2>
    <div id="preguntasFinal"></div>
    <button onclick="finalizarEvaluacion()">Enviar Evaluación</button>
    <p id="resultadoFinal"></p>
    <button class="boton-volver" onclick="volverModulo()">Volver</button>
</section>

<!-- Panel Empresa Completo -->
<div id="panelEmpresa">
    <div id="menuLateral">
        <h3>Datos Empresa</h3>
        <p>Nombre: Empresa XYZ</p>
        <p>RUT: 12.345.678-9</p>
        <button onclick="mostrarSeccionEmpresa('seccionIngreso')">Ingreso de Trabajadores</button>
        <button onclick="mostrarSeccionEmpresa('seccionHistorial')">Historial</button>
        <button onclick="volverMenu()">Volver</button>
    </div>

    <div id="contenidoEmpresa">
        <div id="seccionIngreso" class="seccion">
            <h2>Ingreso de Trabajadores</h2>
            <input type="text" id="nombre" placeholder="Nombre Completo">
            <input type="text" id="rut" placeholder="RUT">
            <input type="text" id="cargo" placeholder="Cargo">
            <input type="text" id="centro" placeholder="Centro de Negocios">
            <input type="date" id="fechaIngreso">
            <button onclick="registrarTrabajador()">Registrar</button>
        </div>

        <div id="seccionHistorial" class="seccion">
            <h2>Historial</h2>
            <table border="1">
                <thead>
                    <tr><th>Nombre</th><th>RUT</th><th>Cargo</th><th>Centro</th><th>Fecha Ingreso</th><th>Curso</th><th>Fecha Aprobación</th><th>Certificado</th></tr>
                </thead>
                <tbody id="tablaHistorial"></tbody>
            </table>
            <button onclick="exportarHistorialExcel()">Exportar a Excel</button>
        </div>
    </div>
</div>

<script>
let trabajadores = JSON.parse(localStorage.getItem("trabajadores")) || [];
let historial = JSON.parse(localStorage.getItem("historial")) || [];
const preguntasFinal = [
    ["¿Los extintores deben estar en un lugar visible?", "si"],
    ["¿Los extintores no necesitan mantención?", "no"],
    ["¿Se debe apuntar a la base del fuego?", "si"]
];

function ocultarTodo() {
    document.querySelectorAll(".seccion").forEach(sec => sec.style.display = "none");
    document.getElementById('menuPrincipal').style.display = "none";
    document.getElementById('panelEmpresa').style.display = "none";
}

function volverMenu() {
    ocultarTodo();
    document.getElementById('menuPrincipal').style.display = 'block';
}
function mostrarTrabajador() {
    ocultarTodo();
    document.getElementById('seccionTrabajador').style.display = 'block';
}
function volverTrabajador() {
    ocultarTodo();
    document.getElementById('seccionTrabajador').style.display = 'block';
}
function volverCursos() {
    ocultarTodo();
    document.getElementById('mosaicoCursos').style.display = 'block';
}
function volverModulo() {
    ocultarTodo();
    document.getElementById('moduloCurso').style.display = 'block';
}
function mostrarEmpresa() {
    ocultarTodo();
    document.getElementById('panelEmpresa').style.display = 'flex';
    mostrarSeccionEmpresa('seccionIngreso');
}
function mostrarSeccionEmpresa(id) {
    document.querySelectorAll('#contenidoEmpresa .seccion').forEach(sec => sec.style.display = "none");
    document.getElementById(id).style.display = "block";
}
function accederTrabajador() {
    const rut = document.getElementById('rutAcceso').value.trim();
    const trabajador = trabajadores.find(t => t.rut === rut);
    if (trabajador) {
        ocultarTodo();
        document.getElementById('mosaicoCursos').style.display = 'block';
    } else {
        alert("Trabajador no habilitado");
    }
}
function verCurso() {
    ocultarTodo();
    document.getElementById('moduloCurso').style.display = 'block';
}
function finalizarModulo() {
    const p1 = document.getElementById('p1').value.trim().toLowerCase();
    const p2 = document.getElementById('p2').value.trim().toLowerCase();
    const p3 = document.getElementById('p3').value.trim().toLowerCase();
    if (p1 === "verdadero" && p2 === "falso" && p3 === "verdadero") {
        ocultarTodo();
        document.getElementById('evaluacionFinal').style.display = 'block';
        cargarEvaluacionFinal();
    } else {
        alert("Debe responder correctamente para continuar.");
    }
}
function cargarEvaluacionFinal() {
    const contenedor = document.getElementById('preguntasFinal');
    contenedor.innerHTML = "";
    preguntasFinal.forEach((preg, index) => {
        contenedor.innerHTML += `${preg[0]}<br><input type='text' id='final${index}'><br>`;
    });
}
function finalizarEvaluacion() {
    let correctas = 0;
    preguntasFinal.forEach((preg, index) => {
        const resp = document.getElementById(`final${index}`).value.trim().toLowerCase();
        if (resp === preg[1]) correctas++;
    });
    const resultado = document.getElementById('resultadoFinal');
    if (correctas >= 3) {
        resultado.textContent = "¡Felicidades! Has aprobado el curso.";
        const trabajador = trabajadores.find(t => t.rut === document.getElementById('rutAcceso').value.trim());
        const fecha = new Date().toLocaleString();
        historial.push({...trabajador, curso:"Uso y Manejo de Extintores", fecha});
        localStorage.setItem("historial", JSON.stringify(historial));
    } else {
        resultado.textContent = "Debes repetir la evaluación.";
    }
}
function registrarTrabajador() {
    const nombre = document.getElementById('nombre').value.trim();
    const rut = document.getElementById('rut').value.trim();
    const cargo = document.getElementById('cargo').value.trim();
    const centro = document.getElementById('centro').value.trim();
    const fechaIngreso = document.getElementById('fechaIngreso').value;
    if (!nombre || !rut || !cargo || !centro || !fechaIngreso) {
        alert("Complete todos los campos");
        return;
    }
    trabajadores.push({nombre, rut, cargo, centro, fechaIngreso});
    localStorage.setItem("trabajadores", JSON.stringify(trabajadores));
}
function exportarHistorialExcel() {
    let csv = "Nombre,RUT,Cargo,Centro,Fecha Ingreso,Curso,Fecha Aprobación\n";
    historial.forEach(h => {
        csv += `${h.nombre},${h.rut},${h.cargo},${h.centro},${h.fechaIngreso},${h.curso},${h.fecha}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "historial_capacitados.csv";
    link.click();
}
</script>

</body>
</html>
