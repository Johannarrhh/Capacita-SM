<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acceso - Capacita SM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background: url('fondo.png') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: flex-start;
}
#menuPrincipal {
    background-color: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 10px;
    margin: 40px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 250px;
}
#menuPrincipal h2 {
    color: #4C7C46;
    margin-bottom: 20px;
}
#menuPrincipal button {
    width: 100%;
    margin: 10px 0;
    padding: 12px;
    font-size: 16px;
    background-color: #4C7C46;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
#menuPrincipal button:hover {
    background-color: #3B6138;
}
#seccionTrabajador, #seccionEmpresa, #seccionHistorial, #moduloCurso, #evaluacionFinal, #mosaicoCursos {
    display: none;
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 10px;
    margin: 20px;
}
.curso-tile {
    background: #A3C95A;
    padding: 10px;
    margin: 10px;
    display: inline-block;
    width: 150px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
}
.boton-volver {
    margin-top: 15px;
    background-color: #A3C95A;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
}
.boton-volver:hover {
    background-color: #4C7C46;
}
</style>
</head>
<body>

<section id="menuPrincipal">
    <h2>Acceso</h2>
    <button onclick="mostrarTrabajador()">Trabajadores</button>
    <button onclick="mostrarEmpresa()">Empresas</button>
</section>

<section id="seccionTrabajador">
    <h2>Ingrese su RUT</h2>
    <input type="text" id="rutAcceso" placeholder="RUT">
    <button onclick="accederTrabajador()">Entrar</button>
</section>

<section id="mosaicoCursos">
    <h2>Cursos Disponibles</h2>
    <div class="curso-tile" onclick="verCurso()">Uso y Manejo de Extintores</div>
</section>

<section id="moduloCurso">
    <h2>Módulo 1: Uso y Manejo de Extintores</h2>
    <p>Contenido del curso...</p>
    <h3>Preguntas (Verdadero/Falso)</h3>
    <p>Los extintores deben estar visibles. <input type="text" id="p1"></p>
    <p>Los extintores no requieren mantención. <input type="text" id="p2"></p>
    <p>Se debe apuntar a la base del fuego. <input type="text" id="p3"></p>
    <button onclick="finalizarModulo()">Finalizar Módulo</button>
</section>

<section id="evaluacionFinal">
    <h2>Evaluación Final</h2>
    <div id="preguntasFinal"></div>
    <button onclick="finalizarEvaluacion()">Enviar Evaluación</button>
    <p id="resultadoFinal"></p>
</section>

<section id="seccionEmpresa">
    <h2>Datos del Trabajador</h2>
    <input type="text" id="nombre" placeholder="Nombre Completo">
    <input type="text" id="rut" placeholder="RUT">
    <input type="text" id="cargo" placeholder="Cargo">
    <input type="text" id="centro" placeholder="Centro de Negocios">
    <input type="date" id="fechaIngreso">
    <button onclick="registrarTrabajador()">Registrar</button>
</section>

<section id="seccionHistorial">
    <h2>Historial de Trabajadores Aprobados</h2>
    <table border="1">
        <thead>
            <tr><th>Nombre</th><th>RUT</th><th>Cargo</th><th>Centro</th><th>Fecha Ingreso</th><th>Curso</th><th>Fecha Aprobación</th><th>Certificado</th></tr>
        </thead>
        <tbody id="tablaHistorial"></tbody>
    </table>
    <button onclick="exportarHistorialExcel()">Exportar a Excel</button>
</section>

<script>
let trabajadores = JSON.parse(localStorage.getItem("trabajadores")) || [];
let historial = JSON.parse(localStorage.getItem("historial")) || [];
const preguntasFinal = [
    ["¿Los extintores deben estar en un lugar visible?", "verdadero"],
    ["¿Los extintores no necesitan mantención?", "falso"],
    ["¿Se debe apuntar a la base del fuego?", "verdadero"],
];

function ocultarTodo() {
    document.getElementById('menuPrincipal').style.display = 'none';
    document.getElementById('seccionTrabajador').style.display = 'none';
    document.getElementById('mosaicoCursos').style.display = 'none';
    document.getElementById('moduloCurso').style.display = 'none';
    document.getElementById('evaluacionFinal').style.display = 'none';
    document.getElementById('seccionEmpresa').style.display = 'none';
    document.getElementById('seccionHistorial').style.display = 'none';
}

function volverMenu() {
    ocultarTodo();
    document.getElementById('menuPrincipal').style.display = 'flex';
}
function volverTrabajador() {
    ocultarTodo();
    document.getElementById('seccionTrabajador').style.display = 'block';
}
function volverCursos() {
    ocultarTodo();
    document.getElementById('mosaicoCursos').style.display = 'block';
}
function volverModulo() {
    ocultarTodo();
    document.getElementById('moduloCurso').style.display = 'block';
}

function mostrarTrabajador() {
    ocultarTodo();
    document.getElementById('seccionTrabajador').style.display = 'block';
}
function mostrarEmpresa() {
    ocultarTodo();
    document.getElementById('seccionEmpresa').style.display = 'block';
    document.getElementById('seccionHistorial').style.display = 'block';
    actualizarHistorial();
}
function accederTrabajador() {
    const rut = document.getElementById('rutAcceso').value.trim();
    const trabajador = trabajadores.find(t => t.rut === rut);
    if (trabajador) {
        ocultarTodo();
        document.getElementById('mosaicoCursos').style.display = 'block';
    } else {
        alert("Trabajador no habilitado");
    }
}
function verCurso() {
    ocultarTodo();
    document.getElementById('moduloCurso').style.display = 'block';
}
function finalizarModulo() {
    const p1 = document.getElementById('p1').value.trim().toLowerCase();
    const p2 = document.getElementById('p2').value.trim().toLowerCase();
    const p3 = document.getElementById('p3').value.trim().toLowerCase();
    if (p1 === "verdadero" && p2 === "falso" && p3 === "verdadero") {
        ocultarTodo();
        document.getElementById('evaluacionFinal').style.display = 'block';
        cargarEvaluacionFinal();
    } else {
        alert("Debe responder correctamente para continuar.");
    }
}
function cargarEvaluacionFinal() {
    const contenedor = document.getElementById('preguntasFinal');
    contenedor.innerHTML = "";
    preguntasFinal.forEach((preg, index) => {
        contenedor.innerHTML += `${preg[0]}<br><input type='text' id='final${index}'><br>`;
    });
}
function finalizarEvaluacion() {
    let correctas = 0;
    preguntasFinal.forEach((preg, index) => {
        const resp = document.getElementById(`final${index}`).value.trim().toLowerCase();
        if (resp === preg[1].toLowerCase()) correctas++;
    });
    const resultado = document.getElementById('resultadoFinal');
    if (correctas >= 3) {
        resultado.textContent = `¡Felicidades! Has aprobado el curso.`;
        const trabajador = trabajadores.find(t => t.rut === document.getElementById('rutAcceso').value.trim());
        const fecha = new Date().toLocaleString();
        historial.push({...trabajador, curso:"Uso y Manejo de Extintores", fecha});
        localStorage.setItem("historial", JSON.stringify(historial));
        actualizarHistorial();
    } else {
        resultado.textContent = "Debes repetir la evaluación.";
    }
}
function registrarTrabajador() {
    const nombre = document.getElementById('nombre').value.trim();
    const rut = document.getElementById('rut').value.trim();
    const cargo = document.getElementById('cargo').value.trim();
    const centro = document.getElementById('centro').value.trim();
    const fechaIngreso = document.getElementById('fechaIngreso').value;
    if (!nombre || !rut || !cargo || !centro || !fechaIngreso) {
        alert("Complete todos los campos");
        return;
    }
    trabajadores.push({nombre, rut, cargo, centro, fechaIngreso});
    localStorage.setItem("trabajadores", JSON.stringify(trabajadores));
    actualizarHistorial();
    alert("Trabajador registrado");
}
function actualizarHistorial() {
    const tabla = document.getElementById('tablaHistorial');
    tabla.innerHTML = "";
    historial.forEach(item => {
        const fila = `<tr>
            <td>${item.nombre}</td>
            <td>${item.rut}</td>
            <td>${item.cargo}</td>
            <td>${item.centro}</td>
            <td>${item.fechaIngreso}</td>
            <td>${item.curso}</td>
            <td>${item.fecha}</td>
            <td><button onclick='generarCertificadoPorDatos("${item.nombre}","${item.rut}")'>Descargar</button></td>
        </tr>`;
        tabla.innerHTML += fila;
    });
}
function exportarHistorialExcel() {
    let csv = "Nombre,RUT,Cargo,Centro,Fecha Ingreso,Curso,Fecha Aprobación\n";
    historial.forEach(h => {
        csv += `${h.nombre},${h.rut},${h.cargo},${h.centro},${h.fechaIngreso},${h.curso},${h.fecha}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "historial_capacitados.csv";
    link.click();
}
function generarCertificado(trabajador) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("CERTIFICADO DE PARTICIPACIÓN", 20, 30);
    doc.setFontSize(12);
    doc.text(`La empresa certifica que ${trabajador.nombre}, RUT ${trabajador.rut}`, 20, 50);
    doc.text("Ha participado y aprobado el curso: Uso y Manejo de Extintores", 20, 60);
    doc.text("Fecha: " + new Date().toLocaleDateString(), 20, 70);
    doc.text("Capacita SM Academy", 20, 80);
    doc.save("certificado.pdf");
}
function generarCertificadoPorDatos(nombre, rut) {
    const trabajador = trabajadores.find(t => t.rut === rut);
    generarCertificado(trabajador);
}
</script>

</body>
</html>
